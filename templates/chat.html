{% extends "layout.html" %}
{% block content %}

<div class="chat-header">
    <h2># ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ‡Ğ°Ñ‚</h2>
</div>

<div id="chat-box" class="chat-box">

{% for msg in messages %}
<div class="chat-message" data-id="{{ msg.id }}">
    <div class="message-wrapper">

        <img class="mini-avatar"
             src="{{ url_for('static', filename='avatars/' + (msg.user.avatar if msg.user.avatar else 'default_avatar.png')) }}">

        <div class="chat-content">
            <strong>
                <a class="chat-username"
                   href="{{ url_for('profile', username=msg.user.username) }}">
                    {{ msg.user.username }}
                </a>
                {% if msg.user.is_verified %}
                    <span style="color:#5865f2;"> âœ”</span>
                {% endif %}
            </strong>

            <div class="message-text">{{ msg.text | safe }}</div>
            <small>{{ msg.timestamp.strftime("%H:%M") }}</small>

            <div class="reactions" id="reactions-{{ msg.id }}"></div>
        </div>

        <!-- Hover buttons -->
        <div class="message-actions">
            <button type="button"
                    onclick="toggleReactionPanel({{ msg.id }}, event)">ğŸ™‚</button>
            <button type="button"
                    onclick="toggleActionPanel(this, event)">âš™</button>
        </div>

        <!-- Reaction panel (Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ emoji) -->
        <div class="reaction-panel" id="reaction-panel-{{ msg.id }}">
            <span onclick="react({{ msg.id }}, 'ğŸ”¥')">ğŸ”¥</span>
            <span onclick="react({{ msg.id }}, 'ğŸ˜‚')">ğŸ˜‚</span>
            <span onclick="react({{ msg.id }}, 'ğŸ‘')">ğŸ‘</span>
            <span onclick="react({{ msg.id }}, 'â¤ï¸')">â¤ï¸</span>
            <span onclick="react({{ msg.id }}, 'ğŸ˜')">ğŸ˜</span>
        </div>

        <!-- Settings panel -->
        <div class="action-panel">
            <button onclick="editMessage({{ msg.id }})">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
            <button onclick="deleteMessage({{ msg.id }})">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
        </div>

    </div>
</div>
{% endfor %}

</div>

<!-- ================= INPUT AREA ================= -->

<div class="chat-input-wrapper">

    <!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ñ… emoji -->
    <button type="button"
            class="custom-emoji-btn"
            onclick="toggleCustomEmojiPanel(event)">
        ğŸ˜Š
    </button>

    <!-- ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ -->
    <div class="custom-emoji-panel" id="customEmojiPanel">
        {% for emoji in all_emojis %}
        <div class="custom-emoji-item"
             onclick="insertCustomEmoji(':emoji:{{ emoji }}:')">
            <img src="{{ url_for('static', filename='emojis/' + emoji) }}">
        </div>
        {% endfor %}
    </div>

    <form class="chat-form" onsubmit="sendMessage(event)">
        <input type="text"
               id="message-input"
               name="message"
               placeholder="ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..."
               autocomplete="off"
               required>
        <button type="submit">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
    </form>

</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
const socket = io();
socket.emit("join_global");

/* ================= REALTIME ================= */

socket.on("receive_global_message", function(msg){

    const chatBox = document.getElementById("chat-box");

    const wrapper = document.createElement("div");
    wrapper.className = "chat-message";
    wrapper.setAttribute("data-id", msg.id);

    wrapper.innerHTML = `
        <div class="message-wrapper">
            <img class="mini-avatar" src="${msg.avatar_url}">
            <div class="chat-content">
                <strong>
                    <a class="chat-username" href="/profile/${msg.username}">
                        ${msg.username}
                    </a>
                    ${msg.is_verified ? '<span style="color:#5865f2;"> âœ”</span>' : ''}
                </strong>
                <div class="message-text">${msg.text}</div>
                <small>${msg.time}</small>
                <div class="reactions" id="reactions-${msg.id}"></div>
            </div>

            <div class="message-actions">
                <button onclick="toggleReactionPanel(${msg.id}, event)">ğŸ™‚</button>
                <button onclick="toggleActionPanel(this, event)">âš™</button>
            </div>

            <div class="reaction-panel" id="reaction-panel-${msg.id}">
                <span onclick="react(${msg.id}, 'ğŸ”¥')">ğŸ”¥</span>
                <span onclick="react(${msg.id}, 'ğŸ˜‚')">ğŸ˜‚</span>
                <span onclick="react(${msg.id}, 'ğŸ‘')">ğŸ‘</span>
                <span onclick="react(${msg.id}, 'â¤ï¸')">â¤ï¸</span>
                <span onclick="react(${msg.id}, 'ğŸ˜')">ğŸ˜</span>
            </div>

            <div class="action-panel">
                <button onclick="editMessage(${msg.id})">Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
                <button onclick="deleteMessage(${msg.id})">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
            </div>
        </div>
    `;

    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
});

/* ================= PANELS ================= */

document.addEventListener("click", function(){
    document.querySelectorAll(".reaction-panel")
        .forEach(p => p.style.display = "none");

    document.querySelectorAll(".action-panel")
        .forEach(p => p.style.display = "none");

    document.getElementById("customEmojiPanel").style.display = "none";
});

function toggleReactionPanel(id, event){
    event.stopPropagation();

    const panel = document.getElementById("reaction-panel-" + id);
    const visible = panel.style.display === "block";

    document.querySelectorAll(".reaction-panel")
        .forEach(p => p.style.display = "none");

    if(!visible){
        panel.style.display = "block";
    }
}

function toggleActionPanel(btn, event){
    event.stopPropagation();

    const panel = btn.closest(".message-wrapper")
                     .querySelector(".action-panel");

    const visible = panel.style.display === "block";

    document.querySelectorAll(".action-panel")
        .forEach(p => p.style.display = "none");

    if(!visible){
        panel.style.display = "block";
    }
}

/* ================= CUSTOM EMOJI ================= */

function toggleCustomEmojiPanel(event){
    event.stopPropagation();
    const panel = document.getElementById("customEmojiPanel");
    panel.style.display =
        panel.style.display === "block" ? "none" : "block";
}

function insertCustomEmoji(code){
    const input = document.getElementById("message-input");
    input.value += " " + code + " ";
    input.focus();
}

/* ================= EDIT ================= */

function editMessage(id){
    const el = document.querySelector(`[data-id="${id}"]`);
    if(!el) return;

    const textDiv = el.querySelector(".message-text");
    const oldText = textDiv.innerText;

    const newText = prompt("ĞĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:", oldText);
    if(!newText || newText.trim() === "") return;

    fetch(`/edit_message/${id}`, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `text=${encodeURIComponent(newText)}`
    });
}

socket.on("message_edited", function(data){
    const el = document.querySelector(`[data-id="${data.id}"]`);
    if(!el) return;
    el.querySelector(".message-text").innerHTML = data.text;
});

/* ================= REACT ================= */

function react(id, emoji){
    fetch(`/react/${id}`, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `emoji=${emoji}`
    });
}

socket.on("reaction_updated", function(data){
    const container = document.getElementById("reactions-" + data.message_id);
    if(!container) return;

    container.innerHTML = "";

    for(const emoji in data.reactions){
        const span = document.createElement("span");
        span.className = "reaction";
        span.textContent = emoji + " " + data.reactions[emoji];
        span.onclick = () => react(data.message_id, emoji);
        container.appendChild(span);
    }
});

/* ================= DELETE ================= */

function deleteMessage(id){
    fetch(`/delete_message/${id}`, { method: "POST" });
}

socket.on("message_deleted", function(data){
    const el = document.querySelector(`[data-id="${data.id}"]`);
    if(el) el.remove();
});

/* ================= SEND ================= */

function sendMessage(event){
    event.preventDefault();

    const input = document.getElementById("message-input");
    const text = input.value.trim();
    if(text === "") return;

    fetch(window.location.pathname, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `message=${encodeURIComponent(text)}`
    });

    input.value = "";
}
</script>

{% endblock %}
